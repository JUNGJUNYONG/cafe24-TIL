[TOC]

# CHAPTER 13, 다중성 확보, 시스템 안정화 :race_car: 

> **100%에 근접한 가동률을 실현하는 원리**
>
> 하테나에서는 가동률을 거의 100%에 달성하도록 목표로 하고 있다.
>
> 가장 중요시 여기는 것은 SPOF(SIngle Point of Failure) - 단일 장애점 제거이다.
>
> -> 한 곳에 장애가 나면 시스템이 멈춰버리는 것을 가능한한 없애도록 노력



## [강의 33, 다중성 확보]

### - 다중성 확보 - AP서버

- 서버를 늘릴 때 중요한 것은 1, 2대가 정지하더라도 충분히 처리할 수 있는 처리능력을 확보하는 것

**서버는 다양한 요인으로 멈춘다.**

> 이에 대한 대응으로, 로드밸런서로 페일오버(장애극복), 페일백(정상복귀)하는 것이다.
>
> 고장난 서버를 **자동적으로 분리**하고, 서버가 복구되면 **원상태로 복귀**시키는 작업
>
> : 이때 로드밸런서는 서버에 대해 주기적으로 헬스체크하며 AP서버나 DB서버가 살아있는지 여부를 판정

```
ex) 로드밸런서와 AP서버 A, B 두 대가 있는 경우 
B가 다운된 경우, 로드밸런서가 B로의 접속을 차단하고 A만으로 처리를 수행하도록 함
시간이 지나 B가 복구되면, 다시 A, B 양쪽으로 요청을 보내 처리함
```



### - 다중성 확보 - DB서버

> **마스터를 다중화하고 있다, ==> 멀티 마스터!**

**어떻게 멀리 마스터 ?**   

서로가 서로의 슬레이브가 되는 상태로  쌍방으로 레플리케이션한다.

> 한쪽에 쓰기 작업을 하면 다른 한쪽으로 전달하고, 반대쪽에서도 쓰기작업을 하면 다른 쪽으로 전달 -> **양방향 레플리케이션**

> MySQL에서는 반대쪽으로 전달되는 흐름이 약간이나마 지연이 있음
>
> -> 밀리초 단위로 보면 데이터가 일치하지 않는 상태가 항상 존재
>
> **-> 리스크가 항상 존재**
>
> 하지만, 계속해서 작동할 수 있도록 하는 데 중점을 두기에 이 부분은 받아들임



#### 멀티 마스터

- 멀티마스터 구성에서 서버는 기본 2대가 있다.
- Active/Standby 구성으로, 한쪽이 Active이고 다른 한쪽은 Standby로 항상 Active만 쓰기 작업을 한다. 
- Active가 서버 다운 되면, Standby가 마스터로 승격
- 서버가 복구되면 다시 원래의 구성으로 

```
DB 페일오버의 동작은 상호간에 VRRP(Virtual Router Redundancy Protocol)라는 프로토콜로 감시를 함. VRRP에 의해 한쪽이 분리된 것을 알게되면 자신이 Active마스터로 승격함.
VRRP는 원래 라우터 용으로 개발된 프로토콜임
```

```
외부에서 어느쪽 서버가 Active인지 판단하기 위해 Virtual IP를 사용
AP서버는 항상 가상 아이피를 엑세스 함으로써 마스터 전환이 AP서버 입장에서는 은폐되어있음
리스크가 있지만, 마스터의 다중성을 확보할 수 있음
```



### - 다중성 확보 - 스토리지 서버

하테나는 미디어 파일 저장을 위해 분산 스토리지 서버(MogileFS)를 사용

분산파일시스템을 사용함으로써, 대량의 파일을 보존할 수 있는 확장성, 일부서버 다운이 전체 장애를 불러오지 않도록 다중성 확보 가능

![mogilefs](https://blog.sixapart.jp/images/mogilefs.png)

MogileFS는 위의 그림과 같이 트래커, 스토리지노드, 트래커DB로 구성되어 있다.

- 실제 파일은 스토리지 노드에 위치
- 특정 URL에 대한 실제 파일 위치를 나타내는 메타 정보를 DB로 관리하는 형태
- 파일은 어디까지나 파일로 다룸
- 하나의 파일이 어디에 위치해 있는지를 나타내는 메타 정보를 별도로 관리하는 방법



**분산 파일 시스템에 이미지 등을 분배하는 것인가?**

> 하테나 에서는 분산파일 시스템에 이미지 등의 미디어 파일을 저장하고 있다.

분산파일 시스템은 특정 노드가 다운되었을 때, 해당 노드가 가지고 있는 데이터를 어떻게 해서 이동시킬 것인지, 특정 노드 상의 파일로 엑세스가 편중될 때 이를 평준화하기 위해 데이터를 어떻게 재배치 할 것인지 등 여러 관련 기술이 있음. -> 인기있는 분야라 생각

- MogileFS는 스토리지 노드를 추가함으로 용량을 거의 무한으로 확대할 수 있음



## [강의 34, 시스템 안정화]

### - 시스템 안정화를 위한 상반관계

**안정성 <---> 자원효율**

```
빠듯할 정도로 메모리를 튜닝해 메모리를 사용하도록 한다면
메모리가 늘어났을 때 곧바로 스왑을 사용하기 시작해서 성능이 저하되며 서비스 장애로 이어짐 
```

**안정성 <---> 속도**

```
CPU를 한계에 다다를 정도로 사용한다면
서버 대수를 줄일 수 있어 비용에선 유리하지만, 1대에 장애가 발생하면 전체적으로 처리 능력이 부족해져 장애가 되는 경우 발생
```

> 이를 방지하기 위해 메모리는 7할 정도까지만 사용, CPU는 7할 정도까지만 사용 등 어느정도 여유를 갖게 설계하는 것이 중요함



### - 시스템의 불안정 요인

#### 애플리케이션/ 서비스 레벨 -> 부하 증가

- 기능 추가 / 메모리 누수

  > 새로운 기능 추가와 메모리 누수는 상당히 불안정한 요인

- 지뢰

  > 특정 URL이 읽히면 아무리 시간이 지나도 응답이 오지 않아 마치 지뢰를 밟은 것 처럼 장애의 원인이 되는 현상 -> 올바르지 않는 데이터나 규격이 맞지 않은 경우 해석할 때 무한 루프에 빠지거나, 메모리를 비정상적으로 소비 -> **시스템 불안정**
  >
  > 지뢰를 밟더라도 문제가 되지 않도록 설계하는 것이 중요

- 사용자의 엑세스 패턴

  > 사용자가 집중적으로 접속해서 다운되는 경우
  >
  > Squid와 같은 캐시 서버를 사이에 추가해 캐시를 사용하면, 리소스를 거의 사용하지 않고 요청에 대한 응답을 반환할 수 있음

- 데이터량 증가

  > 예상했던 데이터량보다 증가했을 경우, DB 설계를 변경해 레코드 수의 증가를 억제 등
  >
  > 데이터가 비정상적으로 늘어나는 것을 빠르게 캐치해 적절한 조치를 취하는 것이 중요

- 외부연계 추가

  > 외부연계를 늘리면 예상치 못하게 외부 시스템과 같이 덩달아 같이 다운되는 경우가 있음
  >
  > 연계하고 있을 경우, 서비스가 영향받지 않도록 구현하는 것이 중요

#### 하드웨어 -> 처리능력 저하

- 메모리/ HDD장애, NIC 장애

  > 하드웨어 능력이 저하되더라도 문제가 되지 않도록 하는 것이 중요!





## [강의 35, 시스템 안정화 대책]

### - 실제 안정화 대책

> **적절한 버퍼 유지와 불안정 요인 제거**

**적정한 버퍼 유지**

> 한계의 7할 운용 수행, 시스템 수용능력의 70%를 넘으면 서버를 추가하거나 메모리를 늘림

**불안정 요인 제거**

> SQL 부하 대책, 메모리 누수 줄이기, 비정상 동작 시 자율 제어

> 부하가 높아질 만한 SQL을 발행할 경우 해당 용도를 위해 격리시킨 DB에 날리도록!



#### 이상 동작 시의 자율 제어

- 자동 DoS판정

  > `F5 어택`이라는 리로드 반복 행위등 비정상적인 요청을 자율적으로 차단
  >
  > 특정 스트립트 싱행시 바로 차단

- 자동 재시작

  > 어느정도 리소스를 지나치게 사용했다 판단 시 웹 서버 재시작
  >
  > 가상화 되어 있는 OS별로 재시작

- 자동 쿼리 제거(소요시간이 긴 SQL문 KILL)

  > DB서버에서 어떤 쿼리가 실행되고 있는 지를 10초마다 파악 후 어느 정도 이상으로 시간이 경과한 쿼리는 `KILL`



위와 같은 제어를 수행하며 자율적으로 안정화 하는 방향으로 시스템을 제어함

> 자율제어는 잠정적인 해법이며, 본질적인 해법이 아니라는 것을 염두에 두고 코드를 작성하는 것이 중요하다.


